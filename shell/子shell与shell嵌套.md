# 子shell与shell嵌套

## 子shell

子Shell的本质可以理解为Shell的子进程。

Shell脚本是从上至下、从左至右依次执行每一行的命令及语句的，即执行完一个命令之后再执行下一个。如果在Shell脚本中遇到子脚本（即脚本嵌套），就会先执行子脚本的内容，完成后再返回父脚本继续执行父脚本内后续的命令及语句。

![image-20220304223949453](子shell与shell嵌套.assets\image-20220304223949453.png)

## 子shell产生途径及特点

1. 带“&”提交后台作业

   由“&”产生的子Shell可以直接引用父Shell定义的本地变量。

   由“&”产生的子Shell中定义的变量不能被父Shell引用。

   在shell中使用“&”可以实现其他程序的多线程并发功能

2. 使用“管道”功能

   由管道产生的子Shell可以直接引用父Shell定义的本地变量。

   由管道产生的子Shell中定义的变量不能被父Shell引用。

   由管道产生的子Shell不能异步执行，只能在执行完毕后才能返回到父Shell环境。

3. 使用“()”功能

   由()产生的子Shell可以直接引用父Shell定义的本地变量。

   由()产生的子Shell中定义的变量不能被父Shell引用。

   由()产生的子Shell不能异步执行，只有在执行完毕后才能返回到父Shell环境。

4. 通过调用外部Shell脚本产生子Shell

   调用外部Shell脚本产生的子Shell可以直接引用父Shell定义的环境变量。

   调用外部Shell脚本产生的子Shell中定义的变量（或者环境变量）不能被父Shell引用。

   调用外部Shell脚本产生的子Shell不能异步执行，只有执行完毕后才能返回到父Shell环境。

## 子shell应用中的坑

### 使用管道与while循环时遭遇的“坑”

使用管道会产生子Shell，子Shell的特性之一就是在子Shell中定义的变量（数组也是变量）无法被父Shell引用

## shell调用脚本的模式说明

### fork模式调用脚本

fork模式是最普通的脚本调用方式，即直接在父脚本里面用“/bin/sh /directory/script.sh”来调用脚本，或者在命令行中给script.sh脚本文件设置执行权限，然后使用/directory/script.sh来调用脚本。

系统会开启一个SubShell（子Shell）执行调用的脚本，SubShell执行的时候ParentShell还在，SubShell执行完毕后返回到ParentShell。最后的结论是SubShell可以从ParentShell继承环境变量，但是默认情况下SubShell中的环境变量不能带回ParentShell。

fork模式调用脚本主要应用于常规嵌套脚本执行的场合，嵌套的脚本只是执行相应的命令操作，不会生成相应的进程信息，父脚本不需要引用嵌套的脚本内的变量及函数等信息，其次在嵌套脚本中定义的变量及函数等不会影响到父脚本中相同的信息定义。

### exec模式调用脚本

exec模式与fork模式调用脚本的方式不同，不需要新开一个Subshell来执行被调用的脚本。被调用的脚本与父脚本在同一个Shell内执行，但是使用exec调用一个新脚本以后，父脚本中exec执行之后的脚本内容就不会再执行了，这就是exec和source的区别。

exec模式调用脚本需要应用于嵌套脚本在主脚本的末尾执行的场合，因此，此种模式的应用并不多见，并且可以被source模式完全取代。

### source模式调用脚本

source模式与fork模式的区别是不会新开一个Subshell来执行被调用的脚本，而是在同一个Shell中执行，所以在被调用的脚本中声明的变量和环境变量都可以在主（父）脚本中获取和使用。

source模式与fork模式的区别是不会新开一个Subshell来执行被调用的脚本，而是在同一个Shell中执行，所以在被调用的脚本中声明的变量和环境变量都可以在主（父）脚本中获取和使用

source模式调用脚本是比较重要且最常用的一种嵌套方式，主要应用之一是执行嵌套脚本启动某些服务程序。source模式调用脚本的另外一个应用就是使得嵌套脚本中的变量及函数等信息被父脚本使用，从而实现更多的业务处理。
